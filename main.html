<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Cadastro - Principal</title>
    <style>
        /* Estilos gerais e importação da fonte */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body, html { height: 100%; font-family: 'Roboto', sans-serif; background-color: #f0f2f5; }

        /* Estilo do container principal */
        .main-container { display: flex; flex-direction: column; height: 100vh; }

        /* Cabeçalho */
        header {
            background-color: #ffffff; padding: 15px 30px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex; justify-content: space-between; align-items: center; z-index: 100;
            flex-wrap: wrap; gap: 15px;
        }
        header h1 { font-size: 22px; color: #1877f2; }
        
        /* Menu de Navegação */
        nav { display: flex; gap: 15px; flex-wrap: wrap; justify-content: flex-start; }
        nav button {
            width: auto; padding: 10px 20px; font-size: 16px; font-weight: 500;
            background-color: #e4e6eb; color: #050505; border: none; border-radius: 8px;
            cursor: pointer; transition: background-color 0.2s;
        }
        nav button:hover { background-color: #d8dadf; }
        
        /* Botão de Logoff */
        #logoffButton { background-color: #fa3e3e; color: white; }
        #logoffButton:hover { background-color: #e33434; }

        @media (max-width: 768px) {
            header { flex-direction: column; align-items: flex-start; }
            nav { width: 100%; justify-content: flex-start; }
        }

        /* Área de conteúdo principal */
        main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .welcome-message { text-align: center; color: #606770; margin-top: 50px; }

        /* Estilos do Loader de Autenticação */
        .loader-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #1877f2; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        .loader-container p { margin-top: 15px; color: #606770; font-size: 16px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- ESTILOS COMUNS (FORMULÁRIO, BUSCA, DETALHES) --- */
        .content-container { background-color: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .content-container h2 { color: #1877f2; margin-bottom: 25px; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
        .form-section { margin-bottom: 30px; }
        .form-section h3 { font-size: 18px; color: #606770; margin-bottom: 20px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group.full-width { grid-column: 1 / -1; }
        .input-group label { font-size: 14px; color: #606770; margin-bottom: 5px; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 10px; border: 1px solid #dddfe2; border-radius: 6px; font-size: 15px; background-color: #fff; }
        .input-group input:focus, .input-group textarea:focus, .input-group select:focus { outline: none; border-color: #1877f2; }
        .input-group input:disabled, .input-group textarea:disabled, .input-group select:disabled { background-color: #f5f5f5; color: #888; }
        .radio-group { display: flex; align-items: center; gap: 20px; height: 41px; }
        .radio-group label { margin-bottom: 0; margin-left: -15px; }
        .form-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; }
        .form-actions button { width: auto; padding: 12px 30px; font-size: 16px; }
        .button-save { background-color: #36a420; color: #fff; border: none; border-radius: 6px; }
        .button-save:hover { background-color: #2f8b1c; }
        .button-edit { background-color: #1877f2; color: #fff; border: none; border-radius: 6px; }
        .button-edit:hover { background-color: #166fe5; }
        .button-secondary { background-color: #e4e6eb; color: #050505; font-weight: 500; width: auto; padding: 10px 20px; font-size: 14px; }
        .button-secondary:hover { background-color: #d8dadf; }
        .dependente-item { border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-top: 20px; background-color: #fafafa; }
        .dependente-item h4 { margin-bottom: 15px; color: #1c1e21; }
        .remove-dependente { background-color: #fa3e3e; color: white; border: none; border-radius: 6px; padding: 10px; cursor: pointer; margin-top: 15px; float: right; }
        .remove-dependente:hover { background-color: #e33434; }
        #form-feedback { padding: 15px; margin-top: 20px; border-radius: 6px; text-align: center; display: none; }
        .feedback-success { background-color: #e6f7e9; color: #1d812a; border: 1px solid #a7d7b0; }
        .feedback-error { background-color: #ffebe6; color: #fa3e3e; border: 1px solid #fa3e3e; }

        /* --- ESTILOS DA BUSCA E RELATÓRIOS --- */
        .search-bar, .report-filters { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .search-bar input, .report-filters select { flex-grow: 1; }
        .search-bar button, .report-filters button { width: auto; font-size: 16px; padding: 10px 20px; background-color: #1877f2; color: #fff; border: none; border-radius: 6px; }
        #search-results, #report-results { margin-top: 20px; }
        .result-item { background-color: #f9f9f9; border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .result-item:hover { background-color: #f0f2f5; }
        .result-item-name { font-weight: 500; }
        .result-item-cpf { font-size: 14px; color: #606770; }
        .result-item button { width: auto; font-size: 14px; padding: 8px 15px; background-color: #36a420; color: #fff; border: none; border-radius: 6px; cursor: pointer; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .report-table th { background-color: #f0f2f5; font-weight: 500; }
        /* NOVO: Estilo para o cabeçalho de grupo no relatório geral */
        .bairro-header td { background-color: #e9ecef; font-weight: bold; }

        /* NOVO: Estilos para impressão */
        @media print {
            body * { visibility: hidden; }
            #report-results, #report-results * { visibility: visible; }
            #report-results { position: absolute; left: 0; top: 0; width: 100%; }
            .report-table { font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- Loader de verificação -->
    <div id="loader" class="loader-container">
        <div class="loader"></div>
        <p>Verificando autenticação...</p>
    </div>

    <!-- Conteúdo principal (começa escondido) -->
    <div id="main-content" class="main-container" style="display: none;">
        <header>
            <h1>Sistema de Cadastro</h1>
            <nav>
                <button id="btn-cadastrar">Cadastrar</button>
                <button id="btn-buscar">Buscar</button>
                <button id="btn-relatorios" style="display: none;">Relatórios</button>
                <button id="logoffButton">Logoff</button>
            </nav>
        </header>

        <main id="content-area">
            <!-- O conteúdo (bem-vindo, formulário, busca, detalhes) será inserido aqui -->
        </main>
    </div>

    <!-- ======================= TEMPLATES ======================= -->

    <template id="form-template">
        <div class="content-container">
            <h2>Cadastro de Novo Contato</h2>
            <form id="memberForm">
                <div class="form-section">
                    <h3>Dados Pessoais</h3>
                    <div class="form-grid">
                        <div class="input-group"><label for="nome">Nome</label><input type="text" id="nome" required></div>
                        <div class="input-group"><label for="apelido">Apelido</label><input type="text" id="apelido"></div>
                        <div class="input-group"><label for="telefone">Telefone</label><input type="text" id="telefone"></div>
                        <div class="input-group"><label for="data_nascimento">Data de Nascimento</label><input type="date" id="data_nascimento"></div>
                        <div class="input-group"><label for="cpf">CPF</label><input type="text" id="cpf"></div>
                        <div class="input-group"><label for="rg">RG</label><input type="text" id="rg"></div>
                        <div class="input-group"><label for="titulo_eleitor">Título de Eleitor</label><input type="text" id="titulo_eleitor"></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Endereço</h3>
                    <div class="form-grid">
                        <div class="input-group"><label for="endereco">Endereço</label><input type="text" id="endereco"></div>
                        <div class="input-group"><label for="bairro">Bairro</label><select id="bairro"></select></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Informações Adicionais</h3>
                    <div class="form-grid">
                        <div class="input-group"><label>É líder?</label><div class="radio-group"><input type="radio" id="lider_sim" name="lider" value="Sim"><label for="lider_sim">Sim</label><input type="radio" id="lider_nao" name="lider" value="Não" checked><label for="lider_nao">Não</label></div></div>
                        <div class="input-group campo-autorizado"><label>Conseguiu emprego?</label><div class="radio-group"><input type="radio" id="emprego_sim" name="emprego" value="Sim"><label for="emprego_sim">Sim</label><input type="radio" id="emprego_nao" name="emprego" value="Não" checked><label for="emprego_nao">Não</label></div></div>
                        <div class="input-group full-width campo-autorizado" id="local_emprego_group" style="display: none;"><label for="local_emprego">Local do Emprego</label><input type="text" id="local_emprego"></div>
                        <div class="input-group full-width"><label for="demandas_atendidas">Demandas Atendidas</label><textarea id="demandas_atendidas" rows="4"></textarea></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Dependentes</h3>
                    <div id="dependentes-container"></div>
                    <button type="button" id="addDependente" class="button-secondary">Adicionar Dependente</button>
                </div>
                <div class="form-actions"><button type="submit" class="button-save">Salvar Cadastro</button></div>
            </form>
            <div id="form-feedback"></div>
        </div>
    </template>

    <template id="search-template">
        <div class="content-container">
            <h2>Buscar Cadastro</h2>
            <form id="searchForm">
                <div class="search-bar">
                    <input type="text" id="searchInput" placeholder="Digite o nome ou apelido para buscar..." class="input-group">
                    <button type="submit">Buscar</button>
                </div>
            </form>
            <div id="search-results"><p>Nenhum resultado para exibir. Inicie uma busca acima.</p></div>
        </div>
    </template>
    
    <template id="details-template">
        <div class="content-container">
            <h2>Detalhes do Cadastro</h2>
            <form id="detailsForm">
                <input type="hidden" id="docId">
                <div class="form-section">
                    <h3>Dados Pessoais</h3>
                    <div class="form-grid">
                        <div class="input-group"><label for="nome">Nome</label><input type="text" id="nome" disabled></div>
                        <div class="input-group"><label for="apelido">Apelido</label><input type="text" id="apelido" disabled></div>
                        <div class="input-group"><label for="telefone">Telefone</label><input type="text" id="telefone" disabled></div>
                        <div class="input-group"><label for="data_nascimento">Data de Nascimento</label><input type="date" id="data_nascimento" disabled></div>
                        <div class="input-group"><label for="cpf">CPF</label><input type="text" id="cpf" disabled></div>
                        <div class="input-group"><label for="rg">RG</label><input type="text" id="rg" disabled></div>
                        <div class="input-group"><label for="titulo_eleitor">Título de Eleitor</label><input type="text" id="titulo_eleitor" disabled></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Endereço</h3>
                    <div class="form-grid">
                        <div class="input-group"><label for="endereco">Endereço</label><input type="text" id="endereco" disabled></div>
                        <div class="input-group"><label for="bairro">Bairro</label><select id="bairro" disabled></select></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Informações Adicionais</h3>
                    <div class="form-grid">
                        <div class="input-group"><label>É líder?</label><div class="radio-group"><input type="radio" id="lider_sim" name="lider" value="Sim" disabled><label for="lider_sim">Sim</label><input type="radio" id="lider_nao" name="lider" value="Não" disabled><label for="lider_nao">Não</label></div></div>
                        <div class="input-group campo-autorizado"><label>Conseguiu emprego?</label><div class="radio-group"><input type="radio" id="emprego_sim" name="emprego" value="Sim" disabled><label for="emprego_sim">Sim</label><input type="radio" id="emprego_nao" name="emprego" value="Não" disabled><label for="emprego_nao">Não</label></div></div>
                        <div class="input-group full-width campo-autorizado" id="local_emprego_group" style="display: none;"><label for="local_emprego">Local do Emprego</label><input type="text" id="local_emprego" disabled></div>
                        <div class="input-group full-width"><label for="demandas_atendidas">Demandas Atendidas</label><textarea id="demandas_atendidas" rows="4" disabled></textarea></div>
                    </div>
                </div>
                <div class="form-section">
                    <h3>Dependentes</h3>
                    <div id="dependentes-list"></div>
                    <button type="button" id="addDependenteEdit" class="button-secondary" style="display: none; margin-top: 15px;">Adicionar Dependente</button>
                </div>
                <div class="form-actions">
                    <button type="button" id="editButton" class="button-edit">Editar</button>
                    <button type="submit" id="saveChangesButton" class="button-save" style="display: none;">Salvar Alterações</button>
                </div>
            </form>
            <div id="form-feedback"></div>
        </div>
    </template>

    <template id="reports-template">
        <div class="content-container">
            <h2>Gerador de Relatórios</h2>
            <div class="report-filters">
                <select id="report-criterion" class="input-group">
                    <option value="">Selecione um critério</option>
                    <option value="lider">Status de Liderança</option>
                    <option value="emprego">Status de Emprego</option>
                    <option value="bairro">Bairro</option>
                    <!-- NOVO: Opção de relatório geral -->
                    <option value="geral_bairro">Geral por Bairro</option>
                </select>
                <div id="report-value-area" class="input-group">
                </div>
                <button id="generate-report-btn">Gerar</button>
                <button id="print-report-btn" class="button-secondary" style="display: none;">Imprimir</button>
            </div>
            <div id="report-results">
                <p>Selecione um critério e um valor para gerar um relatório.</p>
            </div>
        </div>
    </template>


    <!-- ======================= SCRIPT PRINCIPAL ======================= -->
    <script type="module">
        // Importa as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, where, getDocs, orderBy, doc, getDoc, updateDoc, deleteDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // =================================================================================
        // COLE AQUI AS SUAS CHAVES DE CONFIGURAÇÃO DO FIREBASE
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAifFxis5rYKRwfgUpkj9UYT_tYD0GXp44",
			authDomain: "cadastrocardim.firebaseapp.com",
			projectId: "cadastrocardim",
			storageBucket: "cadastrocardim.firebasestorage.app",
			messagingSenderId: "1052838349059",
			appId: "1:1052838349059:web:901c1e4cda9c1946da0136"
        };
        // =================================================================================

        // INÍCIO DA LISTA DE BAIRROS (VOCÊ PODE EDITAR AQUI)
        const bairros = [
            "Arrastão", "Baleia", "Barra do Una", "Barequeçaba", "Boiçucanga", "Boraceia", "Calhetas", "Camburi", "Canto do Mar", "Caraguatatuba", "Centro", 
			"Cigarras", "Enseada", "Figueira", "Guaecá", "Ilhabela", "Itatinga", "Jaraguá", "Juquehy", "Maresias", "Mirante", "Morro do Abrigo","Olaria", "Paúba", 
            "Pontal da Cruz", "Portal da Olaria", "Porto Grande", "Praia Deserta", "Reserva",
            "Sahy", "Santiago", "São Francisco", "Sertão do Camburi", "Topolândia", "Toque-Toque Grande", "Toque-Toque Pequeno",
			"Varadouro", "Vila Amélia", "Vila Sahy"
        ];
        // FIM DA LISTA DE BAIRROS
        
        const USUARIOS_AUTORIZADOS = [
            'danielbastosneto@gmail.com',
            'adv.flaviomoraes@hotmail.com',
            'enzogarcia368@gmail.com',
			'elisid@hotmail.com',
			'lcmcardim@gmail.com',
            'bianouba@gmail.com'
        ];

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const contentArea = document.getElementById('content-area');

        function normalizeText(text) {
            if (!text) return '';
            return text.toString().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
        }

        function calculateAge(birthDateString) {
            if (!birthDateString) return '';
            const birthDate = new Date(birthDateString);
            const today = new Date();
            let age = today.getFullYear() - birthDate.getFullYear();
            const m = today.getMonth() - birthDate.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            return age >= 0 ? `${age} anos` : '';
        }

        function isUserAuthorized() {
            const user = auth.currentUser;
            if (!user || !user.email) return false;
            return USUARIOS_AUTORIZADOS.includes(user.email.toLowerCase());
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('loader').style.display = 'none';
                document.getElementById('main-content').style.display = 'flex';
                if (isUserAuthorized()) {
                    document.getElementById('btn-relatorios').style.display = 'block';
                }
                showWelcomeMessage();
            } else {
                const currentPath = window.location.pathname;
                const newPath = currentPath.substring(0, currentPath.lastIndexOf('/')) + '/index.html';
                window.location.href = newPath;
            }
        });

        document.getElementById('btn-cadastrar').addEventListener('click', () => initRegister());
        document.getElementById('btn-buscar').addEventListener('click', () => initSearch());
        document.getElementById('btn-relatorios').addEventListener('click', () => initReports());
        document.getElementById('logoffButton').addEventListener('click', () => { signOut(auth); });

        function showWelcomeMessage() {
            contentArea.innerHTML = `<div class="welcome-message"><h2>Bem-vindo!</h2><p>Selecione uma opção no menu acima para começar.</p></div>`;
        }
        
        function populateBairrosDropdown(selectElementId, selectedValue = '') {
            const select = document.getElementById(selectElementId);
            if (!select) return;
            select.innerHTML = '<option value="">Selecione um bairro</option>';
            bairros.sort().forEach(bairro => {
                const option = document.createElement('option');
                option.value = bairro;
                option.textContent = bairro;
                if (bairro === selectedValue) { option.selected = true; }
                select.appendChild(option);
            });
        }

        // ========================================================================
        //  LÓGICA DE CADASTRO
        // ========================================================================
        function initRegister() {
            const template = document.getElementById('form-template');
            const clone = template.content.cloneNode(true);

            if (!isUserAuthorized()) {
                clone.querySelectorAll('.campo-autorizado').forEach(el => el.remove());
            }

            contentArea.innerHTML = '';
            contentArea.appendChild(clone);
            populateBairrosDropdown('bairro');
            setupFormListeners();
        }

        function setupFormListeners() {
            const empregoRadios = document.querySelectorAll('input[name="emprego"]');
            if (empregoRadios.length > 0) {
                empregoRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        document.getElementById('local_emprego_group').style.display = e.target.value === 'Sim' ? 'block' : 'none';
                    });
                });
            }

            document.getElementById('addDependente').addEventListener('click', () => {
                const container = document.getElementById('dependentes-container');
                const item = document.createElement('div');
                item.className = 'dependente-item';
                item.innerHTML = `<h4>Novo Dependente</h4><div class="form-grid"><div class="input-group"><label>Nome</label><input type="text" class="dependente-nome" required></div><div class="input-group"><label>Parentesco</label><input type="text" class="dependente-parentesco"></div><div class="input-group"><label>Data de Nascimento</label><input type="date" class="dependente-nascimento"></div><div class="input-group"><label>CPF</label><input type="text" class="dependente-cpf"></div><div class="input-group"><label>RG</label><input type="text" class="dependente-rg"></div><div class="input-group"><label>Título de Eleitor</label><input type="text" class="dependente-titulo"></div></div><button type="button" class="remove-dependente">Remover</button>`;
                container.appendChild(item);
            });
            contentArea.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-dependente')) {
                    e.target.closest('.dependente-item').remove();
                }
            });
            document.getElementById('memberForm').addEventListener('submit', handleFormSubmit);
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const saveButton = e.target.querySelector('button[type="submit"]');
            const feedbackDiv = document.getElementById('form-feedback');
            const nomeValue = document.getElementById('nome').value;

            // NOVO: Verificação de nome duplicado
            const nomeNormalizado = normalizeText(nomeValue);
            const q = query(collection(db, "cadastros"), where("nome_normalizado", "==", nomeNormalizado));
            const querySnapshot = await getDocs(q);

            if (!querySnapshot.empty) {
                feedbackDiv.textContent = 'Erro: Já existe um cadastro com este nome.';
                feedbackDiv.className = 'feedback-error';
                feedbackDiv.style.display = 'block';
                return; // Interrompe o salvamento
            }

            saveButton.disabled = true;
            saveButton.textContent = 'Salvando...';
            feedbackDiv.style.display = 'none';

            try {
                const empregoRadio = document.querySelector('input[name="emprego"]:checked');
                const localEmpregoInput = document.getElementById('local_emprego');
                const apelidoValue = document.getElementById('apelido').value; // Pega o apelido

                const membro = {
                    nome: nomeValue,
                    nome_normalizado: nomeNormalizado,
                    apelido: apelidoValue,
                    apelido_normalizado: normalizeText(apelidoValue), // Salva apelido normalizado
                    telefone: document.getElementById('telefone').value,
                    endereco: document.getElementById('endereco').value,
                    bairro: document.getElementById('bairro').value,
                    cpf: document.getElementById('cpf').value,
                    rg: document.getElementById('rg').value,
                    data_nascimento: document.getElementById('data_nascimento').value,
                    titulo_eleitor: document.getElementById('titulo_eleitor').value,
                    lider: document.querySelector('input[name="lider"]:checked').value,
                    demandas_atendidas: document.getElementById('demandas_atendidas').value,
                    emprego: empregoRadio ? empregoRadio.value : 'Não',
                    local_emprego: localEmpregoInput ? localEmpregoInput.value : '',
                    data_hora_cadastro: serverTimestamp()
                };
                const docRef = await addDoc(collection(db, "cadastros"), membro);
                
                const dependentesElements = document.querySelectorAll('.dependente-item');
                if (dependentesElements.length > 0) {
                    const batch = writeBatch(db);
                    dependentesElements.forEach(item => {
                        const dependenteData = {
                            id_cadastro: docRef.id,
                            nome: item.querySelector('.dependente-nome').value,
                            cpf: item.querySelector('.dependente-cpf').value,
                            rg: item.querySelector('.dependente-rg').value,
                            data_nascimento: item.querySelector('.dependente-nascimento').value,
                            titulo_eleitor: item.querySelector('.dependente-titulo').value,
                            parentesco: item.querySelector('.dependente-parentesco').value,
                        };
                        const depDocRef = doc(collection(db, "dependentes"));
                        batch.set(depDocRef, dependenteData);
                    });
                    await batch.commit();
                }
                
                feedbackDiv.textContent = 'Cadastro salvo com sucesso!';
                feedbackDiv.className = 'feedback-success';
                document.getElementById('memberForm').reset();
                document.getElementById('dependentes-container').innerHTML = '';
                if(localEmpregoInput) localEmpregoInput.parentElement.style.display = 'none';

            } catch (error) {
                console.error("Erro ao salvar no Firestore: ", error);
                feedbackDiv.textContent = 'Erro ao salvar. Verifique o console para mais detalhes.';
                feedbackDiv.className = 'feedback-error';
            } finally {
                feedbackDiv.style.display = 'block';
                saveButton.disabled = false;
                saveButton.textContent = 'Salvar Cadastro';
            }
        }

        // ========================================================================
        //  LÓGICA DE BUSCA E EDIÇÃO
        // ========================================================================
        function initSearch() {
            const template = document.getElementById('search-template');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            
            document.getElementById('searchForm').addEventListener('submit', handleSearchSubmit);
            contentArea.addEventListener('click', (e) => {
                if (e.target.matches('.result-item button')) {
                    const docId = e.target.dataset.id;
                    showDetails(docId);
                }
            });
        }

        async function handleSearchSubmit(e) {
            e.preventDefault();
            const searchTermRaw = document.getElementById('searchInput').value;
            const resultsDiv = document.getElementById('search-results');
            if (!searchTermRaw) {
                resultsDiv.innerHTML = '<p>Por favor, digite um nome ou apelido para buscar.</p>';
                return;
            }
            const searchTermNormalized = normalizeText(searchTermRaw);
            resultsDiv.innerHTML = '<p>Buscando...</p>';

            try {
                // NOVO: Duas buscas em paralelo, uma para nome e outra para apelido
                const nomeQuery = query(collection(db, "cadastros"), 
                                where("nome_normalizado", ">=", searchTermNormalized),
                                where("nome_normalizado", "<=", searchTermNormalized + '\uf8ff'));
                
                const apelidoQuery = query(collection(db, "cadastros"), 
                                where("apelido_normalizado", ">=", searchTermNormalized),
                                where("apelido_normalizado", "<=", searchTermNormalized + '\uf8ff'));

                const [nomeSnapshot, apelidoSnapshot] = await Promise.all([
                    getDocs(nomeQuery),
                    getDocs(apelidoQuery)
                ]);

                // NOVO: Junta os resultados e remove duplicados
                const resultsMap = new Map();
                nomeSnapshot.forEach(doc => resultsMap.set(doc.id, { id: doc.id, ...doc.data() }));
                apelidoSnapshot.forEach(doc => resultsMap.set(doc.id, { id: doc.id, ...doc.data() }));

                const finalResults = Array.from(resultsMap.values()).sort((a, b) => a.nome.localeCompare(b.nome));
                
                if (finalResults.length === 0) {
                    resultsDiv.innerHTML = '<p>Nenhum resultado encontrado.</p>';
                } else {
                    resultsDiv.innerHTML = '';
                    finalResults.forEach((data) => {
                        const resultItem = document.createElement('div');
                        resultItem.className = 'result-item';
                        resultItem.innerHTML = `
                            <div>
                                <div class="result-item-name">${data.nome}</div>
                                <div class="result-item-cpf">CPF: ${data.cpf || 'Não informado'}</div>
                            </div>
                            <button data-id="${data.id}">Ver Detalhes</button>
                        `;
                        resultsDiv.appendChild(resultItem);
                    });
                }
            } catch (error) {
                console.error("Erro ao buscar dados: ", error);
                resultsDiv.innerHTML = '<p class="feedback-error">Ocorreu um erro ao realizar a busca.</p>';
            }
        }

        let dependentesParaEdicao = [];
        
        async function showDetails(docId) {
            contentArea.innerHTML = '<div class="loader-container"><div class="loader"></div><p>Carregando detalhes...</p></div>';
            
            try {
                const docRef = doc(db, "cadastros", docId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    contentArea.innerHTML = '<p class="feedback-error">Cadastro não encontrado.</p>';
                    return;
                }
                
                const data = docSnap.data();
                const dependentesQuery = query(collection(db, "dependentes"), where("id_cadastro", "==", docId));
                const dependentesSnapshot = await getDocs(dependentesQuery);
                
                dependentesParaEdicao = [];
                dependentesSnapshot.forEach(doc => {
                    dependentesParaEdicao.push({ id: doc.id, ...doc.data() });
                });

                const template = document.getElementById('details-template');
                const clone = template.content.cloneNode(true);
                
                if (!isUserAuthorized()) {
                    clone.querySelectorAll('.campo-autorizado').forEach(el => el.remove());
                }

                contentArea.innerHTML = '';
                contentArea.appendChild(clone);
                
                populateBairrosDropdown('bairro', data.bairro);

                document.getElementById('docId').value = docId;
                document.getElementById('nome').value = data.nome || '';
                document.getElementById('apelido').value = data.apelido || '';
                document.getElementById('telefone').value = data.telefone || '';
                document.getElementById('data_nascimento').value = data.data_nascimento || '';
                document.getElementById('cpf').value = data.cpf || '';
                document.getElementById('rg').value = data.rg || '';
                document.getElementById('titulo_eleitor').value = data.titulo_eleitor || '';
                document.getElementById('endereco').value = data.endereco || '';
                document.getElementById('demandas_atendidas').value = data.demandas_atendidas || '';
                document.querySelector(`input[name="lider"][value="${data.lider || 'Não'}"]`).checked = true;

                if (isUserAuthorized()) {
                    document.querySelector(`input[name="emprego"][value="${data.emprego || 'Não'}"]`).checked = true;
                    document.getElementById('local_emprego').value = data.local_emprego || '';
                    document.getElementById('local_emprego_group').style.display = data.emprego === 'Sim' ? 'block' : 'none';
                }

                const dependentesList = document.getElementById('dependentes-list');
                if (dependentesParaEdicao.length > 0) {
                    dependentesParaEdicao.forEach(dep => {
                        const item = document.createElement('div');
                        item.className = 'result-item';
                        const idade = calculateAge(dep.data_nascimento);
                        item.innerHTML = `<div><div class="result-item-name">${dep.nome} (${idade})</div><div class="result-item-cpf">Parentesco: ${dep.parentesco || 'Não informado'}</div></div>`;
                        dependentesList.appendChild(item);
                    });
                } else {
                    dependentesList.innerHTML = '<p>Nenhum dependente cadastrado.</p>';
                }

                document.getElementById('editButton').addEventListener('click', () => enableEditing(docId));
                document.getElementById('detailsForm').addEventListener('submit', handleUpdateSubmit);

            } catch (error) {
                console.error("Erro ao carregar detalhes: ", error);
                contentArea.innerHTML = '<p class="feedback-error">Ocorreu um erro ao carregar os detalhes.</p>';
            }
        }

        function enableEditing(docId) {
            const form = document.getElementById('detailsForm');
            form.querySelectorAll('input, textarea, select').forEach(input => {
                if(input.type !== 'hidden') input.disabled = false;
            });

            document.getElementById('editButton').style.display = 'none';
            document.getElementById('saveChangesButton').style.display = 'block';
            document.getElementById('addDependenteEdit').style.display = 'block';

            const dependentesList = document.getElementById('dependentes-list');
            dependentesList.innerHTML = ''; 

            dependentesParaEdicao.forEach(dep => {
                const item = createDependenteFormItem(dep);
                dependentesList.appendChild(item);
            });
            
            document.getElementById('addDependenteEdit').addEventListener('click', () => {
                const item = createDependenteFormItem(); 
                dependentesList.appendChild(item);
            });
        }
        
        function createDependenteFormItem(dependente = {}) {
            const docId = dependente.id || '';
            const data = dependente;
            
            const item = document.createElement('div');
            item.className = 'dependente-item';
            item.innerHTML = `
                <input type="hidden" class="dependente-id" value="${docId}">
                <h4>${docId ? 'Editando Dependente' : 'Novo Dependente'}</h4>
                <div class="form-grid">
                    <div class="input-group"><label>Nome</label><input type="text" class="dependente-nome" value="${data.nome || ''}" required></div>
                    <div class="input-group"><label>Parentesco</label><input type="text" class="dependente-parentesco" value="${data.parentesco || ''}"></div>
                    <div class="input-group"><label>Data de Nascimento</label><input type="date" class="dependente-nascimento" value="${data.data_nascimento || ''}"></div>
                    <div class="input-group"><label>CPF</label><input type="text" class="dependente-cpf" value="${data.cpf || ''}"></div>
                    <div class="input-group"><label>RG</label><input type="text" class="dependente-rg" value="${data.rg || ''}"></div>
                    <div class="input-group"><label>Título de Eleitor</label><input type="text" class="dependente-titulo" value="${data.titulo_eleitor || ''}"></div>
                </div>
                <button type="button" class="remove-dependente">Remover</button>`;
            
            item.querySelector('.remove-dependente').addEventListener('click', () => item.remove());
            return item;
        }

        async function handleUpdateSubmit(e) {
            e.preventDefault();
            const saveButton = document.getElementById('saveChangesButton');
            const feedbackDiv = document.getElementById('form-feedback');
            const docId = document.getElementById('docId').value;

            saveButton.disabled = true;
            saveButton.textContent = 'Salvando...';
            feedbackDiv.style.display = 'none';

            try {
                const batch = writeBatch(db);

                const empregoRadio = document.querySelector('input[name="emprego"]:checked');
                const localEmpregoInput = document.getElementById('local_emprego');
                const nomeValue = document.getElementById('nome').value;
                const apelidoValue = document.getElementById('apelido').value;

                const updatedData = {
                    nome: nomeValue,
                    nome_normalizado: normalizeText(nomeValue),
                    apelido: apelidoValue,
                    apelido_normalizado: normalizeText(apelidoValue),
                    telefone: document.getElementById('telefone').value,
                    data_nascimento: document.getElementById('data_nascimento').value,
                    cpf: document.getElementById('cpf').value,
                    rg: document.getElementById('rg').value,
                    titulo_eleitor: document.getElementById('titulo_eleitor').value,
                    endereco: document.getElementById('endereco').value,
                    bairro: document.getElementById('bairro').value,
                    lider: document.querySelector('input[name="lider"]:checked').value,
                    emprego: empregoRadio ? empregoRadio.value : 'Não',
                    local_emprego: localEmpregoInput ? localEmpregoInput.value : '',
                    demandas_atendidas: document.getElementById('demandas_atendidas').value,
                };
                const docRef = doc(db, "cadastros", docId);
                batch.update(docRef, updatedData);

                const dependentesFormItems = document.querySelectorAll('#dependentes-list .dependente-item');
                const dependentesIdsNaTela = new Set();

                dependentesFormItems.forEach(item => {
                    const depId = item.querySelector('.dependente-id').value;
                    const depData = {
                        id_cadastro: docId,
                        nome: item.querySelector('.dependente-nome').value,
                        cpf: item.querySelector('.dependente-cpf').value,
                        rg: item.querySelector('.dependente-rg').value,
                        data_nascimento: item.querySelector('.dependente-nascimento').value,
                        titulo_eleitor: item.querySelector('.dependente-titulo').value,
                        parentesco: item.querySelector('.dependente-parentesco').value,
                    };

                    if (depId) {
                        batch.update(doc(db, "dependentes", depId), depData);
                        dependentesIdsNaTela.add(depId);
                    } else {
                        batch.set(doc(collection(db, "dependentes")), depData);
                    }
                });
                
                dependentesParaEdicao.forEach(depOriginal => {
                    if (!dependentesIdsNaTela.has(depOriginal.id)) {
                        batch.delete(doc(db, "dependentes", depOriginal.id));
                    }
                });

                await batch.commit();

                feedbackDiv.textContent = 'Alterações salvas com sucesso!';
                feedbackDiv.className = 'feedback-success';
                
                showDetails(docId);

            } catch (error) {
                console.error("Erro ao atualizar documento: ", error);
                feedbackDiv.textContent = 'Erro ao salvar as alterações.';
                feedbackDiv.className = 'feedback-error';
            } finally {
                feedbackDiv.style.display = 'block';
                saveButton.disabled = false;
                saveButton.textContent = 'Salvar Alterações';
            }
        }

        // ========================================================================
        //  LÓGICA DE RELATÓRIOS
        // ========================================================================
        function initReports() {
            if (!isUserAuthorized()) {
                showWelcomeMessage();
                alert('Você não tem permissão para acessar esta área.');
                return;
            }

            const template = document.getElementById('reports-template');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            
            const criterionSelect = document.getElementById('report-criterion');
            criterionSelect.addEventListener('change', updateReportValueControl);
            
            document.getElementById('generate-report-btn').addEventListener('click', handleReportGeneration);
            document.getElementById('print-report-btn').addEventListener('click', () => window.print());
        }
        
        function updateReportValueControl() {
            const criterion = document.getElementById('report-criterion').value;
            const valueArea = document.getElementById('report-value-area');
            
            if (criterion === 'lider' || criterion === 'emprego') {
                valueArea.innerHTML = `<select id="report-value" class="input-group"><option value="Sim">Sim</option><option value="Não">Não</option></select>`;
            } else if (criterion === 'bairro') {
                valueArea.innerHTML = `<select id="report-value" class="input-group"></select>`;
                populateBairrosDropdown('report-value');
            } else {
                valueArea.innerHTML = '';
            }
        }
        
        async function handleReportGeneration() {
            const criterion = document.getElementById('report-criterion').value;
            const valueSelect = document.getElementById('report-value');
            const resultsDiv = document.getElementById('report-results');
            const printBtn = document.getElementById('print-report-btn');
            
            printBtn.style.display = 'none';

            if (!criterion) { // NOVO: Tratamento para o relatório geral
                resultsDiv.innerHTML = '<p>Selecione um critério.</p>';
                return;
            }

            resultsDiv.innerHTML = '<p>Gerando relatório...</p>';

            try {
                let q;
                if (criterion === 'geral_bairro') {
                    q = query(collection(db, "cadastros"), orderBy("bairro"), orderBy("nome"));
                } else {
                    if (!valueSelect) {
                        resultsDiv.innerHTML = '<p>Por favor, selecione um valor.</p>';
                        return;
                    }
                    const value = valueSelect.value;
                    q = query(collection(db, "cadastros"), where(criterion, "==", value), orderBy("nome"));
                }

                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    resultsDiv.innerHTML = '<p>Nenhum resultado encontrado para este critério.</p>';
                } else {
                    let headers = '';
                    let rows = '';
                    let currentBairro = null;

                    switch(criterion) {
                        case 'lider':
                            headers = '<th>Nome</th><th>Apelido</th><th>Telefone</th><th>Bairro</th>';
                            break;
                        case 'emprego':
                            headers = '<th>Nome</th><th>Apelido</th><th>Telefone</th><th>Local do Emprego</th>';
                            break;
                        case 'bairro':
                        case 'geral_bairro':
                            headers = '<th>Nome</th><th>Apelido</th><th>Telefone</th><th>É Líder?</th>';
                            break;
                    }
                    
                    querySnapshot.forEach(doc => {
                        const data = doc.data();

                        if (criterion === 'geral_bairro' && data.bairro !== currentBairro) {
                            currentBairro = data.bairro;
                            rows += `<tr class="bairro-header"><td colspan="4">${currentBairro || 'Sem Bairro'}</td></tr>`;
                        }

                        rows += `<tr>`;
                        switch(criterion) {
                            case 'lider':
                                rows += `<td>${data.nome || ''}</td><td>${data.apelido || ''}</td><td>${data.telefone || ''}</td><td>${data.bairro || ''}</td>`;
                                break;
                            case 'emprego':
                                rows += `<td>${data.nome || ''}</td><td>${data.apelido || ''}</td><td>${data.telefone || ''}</td><td>${data.local_emprego || ''}</td>`;
                                break;
                            case 'bairro':
                            case 'geral_bairro':
                                rows += `<td>${data.nome || ''}</td><td>${data.apelido || ''}</td><td>${data.telefone || ''}</td><td>${data.lider || ''}</td>`;
                                break;
                        }
                        rows += `</tr>`;
                    });
                    
                    const tableHTML = `<table class="report-table"><thead><tr>${headers}</tr></thead><tbody>${rows}</tbody></table>`;
                    resultsDiv.innerHTML = tableHTML;
                    printBtn.style.display = 'inline-block';
                }
            } catch (error) {
                console.error("Erro ao gerar relatório: ", error);
                resultsDiv.innerHTML = '<p class="feedback-error">Ocorreu um erro ao gerar o relatório.</p>';
            }
        }
    </script>
</body>
</html>
